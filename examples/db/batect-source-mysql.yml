containers:
  source-db:
    image: mysql:8
    environment:
      MYSQL_RANDOM_ROOT_PASSWORD: 'true'
      MYSQL_DATABASE: <{db-name}
      MYSQL_USER: <{db-user}
      MYSQL_PASSWORD: <{db-password}
    ports:
      - local: 8000
        container: 3306
    volumes:
      - type: cache
        name: source-db-mysql
        container: /var/lib/mysql
  source-flyway-mysql:
    image: flyway/flyway:8-alpine
    environment:
      FLYWAY_URL: jdbc:mysql://source-db:3306/<{db-name}?allowPublicKeyRetrieval=true
      FLYWAY_USER: <{db-user}
      FLYWAY_PASSWORD: <{db-password}
      FLYWAY_CONNECT_RETRIES: 60
      FLYWAY_EDITION: community
    command: clean migrate
    dependencies:
      - source-db
    volumes:
      - local: ../scenario/<{example-scenario}/source
        container: /flyway/sql
        options: ro
tasks:
  migrate-source-mysql:
    description: Start and populate a source mysql DB from `config_variables.example-scenario`
    group: db
    run:
      container: source-flyway-mysql
